<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notion Confirm Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Notion Confirm Fix</h1>
    <p>This page tests the Notion updating functionality to identify and fix any issues.</p>

    <div class="test-section">
        <h3>1. Test Notion Worker Connection</h3>
        <button onclick="testWorkerConnection()">Test Worker Connection</button>
        <div id="workerResult"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Record Fetching</h3>
        <button onclick="testRecordFetching()">Fetch Records</button>
        <div id="recordsResult"></div>
    </div>

    <div class="test-section">
        <h3>3. Test Specific Record Loading</h3>
        <input type="text" id="formulaIdInput" placeholder="Enter Formula ID (e.g., 251023100300)" value="251023100300">
        <button onclick="testSpecificRecord()">Load Specific Record</button>
        <div id="specificResult"></div>
    </div>

    <div class="test-section">
        <h3>4. Test Confirm Functionality (PATCH)</h3>
        <input type="text" id="confirmFormulaId" placeholder="Formula ID to confirm" value="251023100300">
        <button onclick="testConfirmFunctionality()">Test Confirm</button>
        <div id="confirmResult"></div>
    </div>

    <div class="test-section info">
        <h3>üìã Console Log</h3>
        <div id="consoleLog" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
        }

        async function testWorkerConnection() {
            const resultDiv = document.getElementById('workerResult');
            resultDiv.innerHTML = '<p>Testing worker connection...</p>';
            
            try {
                log('üîÑ Testing Cloudflare worker connection...');
                
                const response = await fetch('https://notion-reader.debabratamaitra898.workers.dev/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Worker Connection Successful</h4>
                        <p><strong>Total Records:</strong> ${data.total}</p>
                        <p><strong>Has More:</strong> ${data.has_more}</p>
                        <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                    </div>
                `;
                
                log(`‚úÖ Worker connection successful. Found ${data.total} records.`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Worker Connection Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Worker connection failed: ${error.message}`, 'error');
            }
        }

        async function testRecordFetching() {
            const resultDiv = document.getElementById('recordsResult');
            resultDiv.innerHTML = '<p>Fetching records...</p>';
            
            try {
                log('üîÑ Fetching Notion records...');
                
                const response = await fetch('https://notion-reader.debabratamaitra898.workers.dev/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Extract records with JSON content
                const records = data.items
                    .filter(item => {
                        const hasJson = item.properties && item.properties.JSON && item.properties.JSON.trim() !== '';
                        const hasId = item.properties && (item.properties.ID || item.id);
                        return hasJson && hasId;
                    })
                    .map(item => ({
                        formula_id: item.properties.ID || item.id,
                        username: item.properties.Username || 'Unknown User',
                        caption: item.properties.Caption || 'No caption',
                        status: item.properties.Status || 'Unknown',
                        page_id: item.id,
                        created_time: item.created_time,
                        last_edited_time: item.last_edited_time
                    }))
                    .sort((a, b) => new Date(b.last_edited_time) - new Date(a.last_edited_time));

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Records Fetched Successfully</h4>
                        <p><strong>Total Records with JSON:</strong> ${records.length}</p>
                        <h5>Recent Records:</h5>
                        <ul>
                            ${records.slice(0, 5).map(record => `
                                <li>
                                    <strong>ID:</strong> ${record.formula_id} | 
                                    <strong>User:</strong> ${record.username} | 
                                    <strong>Status:</strong> ${record.status}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
                log(`‚úÖ Successfully loaded ${records.length} records with JSON content.`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Record Fetching Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Record fetching failed: ${error.message}`, 'error');
            }
        }

        async function testSpecificRecord() {
            const formulaId = document.getElementById('formulaIdInput').value.trim();
            const resultDiv = document.getElementById('specificResult');
            
            if (!formulaId) {
                resultDiv.innerHTML = '<div class="error"><p>Please enter a Formula ID</p></div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Loading specific record...</p>';
            
            try {
                log(`üîÑ Loading record with ID: ${formulaId}`);
                
                const workerUrl = `https://notion-reader.debabratamaitra898.workers.dev/?json_id=${encodeURIComponent(formulaId)}`;
                
                const response = await fetch(workerUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}. ${errorText}`);
                }

                const recordData = await response.json();
                
                if (recordData.error) {
                    throw new Error(recordData.error);
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Record Loaded Successfully</h4>
                        <p><strong>Formula ID:</strong> ${recordData.formula_id}</p>
                        <p><strong>Username:</strong> ${recordData.username}</p>
                        <p><strong>Status:</strong> ${recordData.status}</p>
                        <p><strong>Endpoint:</strong> ${recordData.endpoint}</p>
                        <p><strong>Has JSON:</strong> ${recordData.json_parsed ? 'Yes' : 'No'}</p>
                        <details>
                            <summary>View Full Record Data</summary>
                            <pre>${JSON.stringify(recordData, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                log(`‚úÖ Successfully loaded record: ${recordData.username} (${recordData.formula_id})`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Record Loading Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Record loading failed: ${error.message}`, 'error');
            }
        }

        async function testConfirmFunctionality() {
            const formulaId = document.getElementById('confirmFormulaId').value.trim();
            const resultDiv = document.getElementById('confirmResult');
            
            if (!formulaId) {
                resultDiv.innerHTML = '<div class="error"><p>Please enter a Formula ID to confirm</p></div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Testing confirm functionality...</p>';
            
            try {
                log(`üîÑ Testing confirm functionality for ID: ${formulaId}`);
                
                // First, load the record to get current data
                const loadUrl = `https://notion-reader.debabratamaitra898.workers.dev/?json_id=${encodeURIComponent(formulaId)}`;
                const loadResponse = await fetch(loadUrl);
                
                if (!loadResponse.ok) {
                    throw new Error(`Failed to load record: HTTP ${loadResponse.status}`);
                }
                
                const recordData = await loadResponse.json();
                
                if (recordData.error) {
                    throw new Error(`Failed to load record: ${recordData.error}`);
                }
                
                log(`üì• Loaded record data for confirmation test`, 'info');
                
                // Now test the PATCH functionality
                const patchUrl = `https://notion-reader.debabratamaitra898.workers.dev/?formula_id=${encodeURIComponent(formulaId)}`;
                
                const testPayload = {
                    json: recordData.json_parsed || recordData.json_raw || '{}',
                    status: 'Confirmed'
                };
                
                log(`üì§ Sending PATCH request with payload...`, 'info');
                
                const patchResponse = await fetch(patchUrl, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(testPayload)
                });

                if (!patchResponse.ok) {
                    const errorText = await patchResponse.text();
                    throw new Error(`PATCH failed: HTTP ${patchResponse.status}: ${patchResponse.statusText}. ${errorText}`);
                }

                const patchResult = await patchResponse.json();
                
                if (patchResult.error) {
                    throw new Error(`PATCH failed: ${patchResult.error}`);
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Confirm Functionality Working</h4>
                        <p><strong>Record ID:</strong> ${formulaId}</p>
                        <p><strong>Status Updated:</strong> Confirmed</p>
                        <p><strong>Success:</strong> ${patchResult.success}</p>
                        <p><strong>Message:</strong> ${patchResult.message}</p>
                        <details>
                            <summary>View PATCH Response</summary>
                            <pre>${JSON.stringify(patchResult, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                log(`‚úÖ Confirm functionality test successful for ${formulaId}`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Confirm Functionality Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Confirm functionality test failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üöÄ Notion Confirm Fix Test Page Loaded', 'info');
    </script>
</body>
</html>